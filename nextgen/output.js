!function(){function e(){i()&&(document.body.className="iframe")}function s(t,e,i,r){return r=r||o,i=t.createShader(i),t.shaderSource(i,e),t.compileShader(i),t.getShaderParameter(i,t.COMPILE_STATUS)?i:(lastError=t.getShaderInfoLog(i),r("*** Error compiling shader '"+i+"':"+lastError),t.deleteShader(i),null)}var o=function(t){window.console&&(window.console.error?window.console.error(t):window.console.log&&window.console.log(t))},i=function(){return window!=window.top},r=function(t){return'<table style="background-color: #8CE; width: 100%; height: 100%;"><tr><td align="center"><div style="display: table-cell; vertical-align: middle;"><div style="">'+t+"</div></div></td></tr></table>"},n='This page requires a browser that supports WebGL.<br/><a href="http://get.webgl.org">Click here to upgrade your browser.</a>',a='It doesn\'t appear your computer can support WebGL.<br/><a href="http://get.webgl.org/troubleshooting/">Click here for more information.</a>',l=function(t,e){for(var i=["webgl","experimental-webgl"],r=null,n=0;n<i.length;++n){try{r=t.getContext(i[n],e)}catch(t){}if(r)break}return r};this.createProgram=function(t,e,i,r){for(var n=t.createProgram(),a=0;a<e.length;++a)t.attachShader(n,e[a]);if(i)for(a=0;a<i.length;++a)t.bindAttribLocation(n,r?r[a]:a,i[a]);return t.linkProgram(n),t.getProgramParameter(n,t.LINK_STATUS)?n:(lastError=t.getProgramInfoLog(n),o("Error in program linking:"+lastError),t.deleteProgram(n),null)},this.createShaderFromScriptElement=function(t,e,i,r){var n,a,o=document.getElementById(e);if(!o)throw"*** Error: unknown script element"+e;if(n=o.text,!i)if("x-shader/x-vertex"==o.type)a=t.VERTEX_SHADER;else if("x-shader/x-fragment"==o.type)a=t.FRAGMENT_SHADER;else if(a!=t.VERTEX_SHADER&&a!=t.FRAGMENT_SHADER)throw"*** Error: unknown shader type";return s(t,n,i||a,r)},this.loadShader=s,this.getWebGLContext=function(t){i()&&(e(),t.width=t.clientWidth,t.height=t.clientHeight);t=function(i,t){function e(t){var e=i.parentNode;e&&(e.innerHTML=r(t))}if(!window.WebGLRenderingContext)return e(n),null;t=l(i,t);return t||e(a),t}(t,{preserveDrawingBuffer:!0,antialias:!0});return t.getExtension("GL_OES_standard_derivatives"),t.getExtension("OES_standard_derivatives"),t},this.updateCSSIfInIFrame=e,window.requestAnimFrame=window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(t,e){return window.setTimeout(t,1e3/60)},window.cancelRequestAnimFrame=window.cancelCancelRequestAnimationFrame||window.webkitCancelRequestAnimationFrame||window.mozCancelRequestAnimationFrame||window.oCancelRequestAnimationFrame||window.msCancelRequestAnimationFrame||window.clearTimeout}();"use strict";function BBOXINT(){this.cellmini=0,this.cellmaxi=0,this.cellminj=0,this.cellmaxj=0}function BBOX(){this.xmin=0,this.ymin=0,this.xmax=0,this.ymax=0}function Cell(t,e){this.quadtree=t,this.bbox=e,this.bboxcircleint=new BBOXINT,this.subcirclelists=[],this.sublistindices=[],this.circlelist=new Float64Array(t.NMAXINDEX),this.cindex=0}function MetaQuadTree(t,e,i){this.errormargin=i,this.qtradius=t,this.cellsize=e,this.subcellsize=.2,this.nsubcells=Math.floor(e/this.subcellsize),this.nsubcellsless=this.nsubcells-1,this.nsubcells2=this.nsubcells*this.nsubcells,this.NMAXINDEX=300,this.bboxcircleint=new BBOXINT,this.newnode=new Float64Array(3);var r=Math.floor(2*t/e);this.ncells=r,this.ncellsless=r-1;for(var n=new Array(r*r),a=-t,o=-t,s=0;s<r;s++){for(var l=a+e,o=-t,c=0;c<r;c++){var d=o+e,p=s*r+c,u=new BBOX;u.setfromcoords(a,o,l,d),n[p]=new Cell(this,u),o=d}a=l}this.mcells=n}function addclick(t,e){document.getElementById(t).onclick=e}function mymax(t){if(t.length<1)return null;for(var e=t[0],i=1;i<t.length;i++)t[i]>e&&(e=t[i]);return e}function mymin(t){if(t.length<1)return null;for(var e=t[0],i=1;i<t.length;i++)t[i]<e&&(e=t[i]);return e}BBOX.prototype.setfromcoords=function(t,e,i,r){return this.xmin=t,this.ymin=e,this.xmax=i,this.ymax=r,this},Cell.prototype.split=function(t){var e=this.quadtree,i=e.nsubcells2,r=e.NMAXINDEX;this.subcirclelists=new Float64Array(i*r),this.sublistindices=new Int16Array(i),this.cindex=-1;for(var n=this.circlelist,a=0;a<r;)t[0]=n[a++],t[1]=n[a++],t[2]=n[a++],this.computesubcells(t),this.add(t)},Cell.prototype.circles=function(){var t=[];if(-1===this.cindex)for(var e=0;e<this.quadtree.nsubcells;e++)for(var i=0;i<this.quadtree.nsubcells;i++){var r=e*this.quadtree.nsubcells+i,n=this.sublistindices[r],r=r*this.quadtree.NMAXINDEX;0<n&&(t=t.concat(this.subcirclelists.slice(r,r+n)))}else t=this.circlelist.slice(0,this.cindex);return t},Cell.prototype.add=function(t){var e=this.quadtree,i=(e.errormargin,e.NMAXINDEX),r=t[0],n=t[1],a=t[2];if(-1===(x=this.cindex)){var o=this.bboxcircleint,s=o.cellmini,l=o.cellmaxi,c=o.cellminj,d=o.cellmaxj,p=e.nsubcells;const g=this.sublistindices,v=this.subcirclelists;for(var u=s;u<=l;u++)for(var h=c;h<=d;h++){var f=u*p+h,m=g[f],x=f*i+m;v[x++]=r,v[x++]=n,v[x++]=a,g[f]=m+3,i<m&&console.log("subcell "+f+" overflow ")}}else{const b=this.circlelist;b[x++]=r,b[x++]=n,b[x++]=a,(this.cindex=x)===i&&this.split(t)}},Cell.prototype.computesubcells=function(t){var e=this.quadtree,i=e.errormargin,r=t[0],n=t[1],a=t[2],o=(r+a)*(1+i),s=(n-a)*(1-i),l=(n+a)*(1+i),c=e.subcellsize,t=e.nsubcellsless,n=this.bbox,e=n.xmin,n=n.ymin;const d=Math.floor;i=d(((r-a)*(1-i)-e)/c);i<0&&(i=0);e=d((o-e)/c);t<e&&(e=t);s=d((s-n)/c);s<0&&(s=0);c=d((l-n)/c);t<c&&(c=t);const p=this.bboxcircleint;p.cellmini=i,p.cellmaxi=e,p.cellminj=s,p.cellmaxj=c},Cell.prototype.iscollidingsplit=function(t){this.computesubcells(t);for(var e=this.quadtree,i=e.NMAXINDEX,r=t[0],n=t[1],a=t[2],o=(e.errormargin,this.bboxcircleint),t=o.cellmini,s=o.cellmaxi,l=o.cellminj,c=o.cellmaxj,d=e.nsubcells,p=this.subcirclelists,u=this.sublistindices,h=t;h<=s;h++)for(var f=l;f<=c;f++)for(var m=h*d+f,x=u[m],g=m*i,v=0;v<x;){var b=r-p[g++],y=n-p[g++],w=a+p[g++];if(b*b+y*y-w*w<-1e-6)return!0;v+=3}return!1},Cell.prototype.iscollidingsplitall=function(t){var e=[];this.computesubcells(t);for(var i=this.quadtree,r=i.NMAXINDEX,n=t[0],a=t[1],o=t[2],s=(i.errormargin,this.bboxcircleint),t=s.cellmini,l=s.cellmaxi,c=s.cellminj,d=s.cellmaxj,p=i.nsubcells,u=this.subcirclelists,h=this.sublistindices,f=t;f<=l;f++)for(var m=c;m<=d;m++)for(var x=f*p+m,g=h[x],v=x*r,b=0;b<g;){var y=u[v++],w=u[v++],E=u[v++],C=n-y,A=a-w,k=o+E;if(C*C+A*A-k*k<-1e-6){for(var R=!0,S=0;S<e.length;S++){var M=e[S];if(Math.abs(M[0]-y)<.001&&Math.abs(M[1]-w)<.001){R=!1;break}}R&&e.push([y,w,E])}b+=3}return e},Cell.prototype.iscollidingsimple=function(t){this.quadtree.errormargin;for(var e=this.circlelist,i=this.cindex,r=t[0],n=t[1],a=t[2],o=0;o<i;){var s=r-e[o++],l=n-e[o++],c=a+e[o++];if(s*s+l*l-c*c<-1e-6)return!0}return!1},Cell.prototype.iscollidingsimpleall=function(t){for(var e=[],i=(this.quadtree.errormargin,this.circlelist),r=this.cindex,n=t[0],a=t[1],o=t[2],s=0;s<r;){var l=i[s++],c=i[s++],d=i[s++],p=n-l,u=a-c,h=o+d;p*p+u*u-h*h<-1e-6&&e.push([l,c,d])}return e},MetaQuadTree.prototype.add=function(t){var e=this.ncells,i=this.bboxcircleint,r=i.cellmini,n=i.cellmaxi,a=i.cellminj,o=i.cellmaxj;const s=this.mcells;for(var l=r;l<=n;l++)for(var c=a;c<=o;c++)s[l*e+c].add(t)},MetaQuadTree.prototype.iscolliding=function(t){for(var e=this.ncells,i=this.bboxcircleint,r=i.cellmini,n=i.cellmaxi,a=i.cellminj,o=i.cellmaxj,s=this.mcells,l=r;l<=n;l++)for(var c=a;c<=o;c++){const d=s[l*e+c];if(-1===d.cindex){if(d.iscollidingsplit(t))return!0}else if(d.iscollidingsimple(t))return!0}return!1},MetaQuadTree.prototype.computecellindices=function(t){var e=this.qtradius,i=this.errormargin,r=t[0],n=t[1],a=t[2],o=(r+a)*(1+i),s=(n-a)*(1-i),l=(n+a)*(1+i),c=-e,t=-e,n=this.cellsize,e=this.ncellsless;const d=Math.floor;i=d(((r-a)*(1-i)-c)/n);i<0&&(i=0);c=d((o-c)/n);e<c&&(c=e);s=d((s-t)/n);s<0&&(s=0);n=d((l-t)/n);e<n&&(n=e);const p=this.bboxcircleint;p.cellmini=i,p.cellmaxi=c,p.cellminj=s,p.cellmaxj=n},MetaQuadTree.prototype.checkadd=function(t,e,i){var r=this.qtradius;if(t+i<-r||r<t-i||e+i<-r||r<e-i)return!1;const n=this.newnode;return n[0]=t,n[1]=e,n[2]=i,this.computecellindices(n),!this.iscolliding(n)&&(this.add(n),!0)},MetaQuadTree.prototype.circles=function(){for(var t=[],e=0;e<this.mcells.length;e++){const i=this.mcells[e];t+=i.circles()}return t},MetaQuadTree.prototype.collidings=function(t,e){var i=[];const r=this.newnode;r[0]=t.x,r[1]=t.y,r[2]=t.r,this.computecellindices(r);for(var n=this.ncells,a=this.bboxcircleint,t=a.cellmini,o=a.cellmaxi,s=a.cellminj,l=a.cellmaxj,c=this.mcells,d=t;d<=o;d++)for(var p=s;p<=l;p++){const v=c[d*n+p];for(var u=[],u=-1===v.cindex?v.iscollidingsplitall(r):v.iscollidingsimpleall(r),h=0;h<u.length;h++){for(var f=u[h],m=!0,x=0;x<i.length;x++){var g=i[x];if(Math.abs(f[0]-g[0])<.001&&Math.abs(f[1]-g[1])<.001){m=!1;break}}m&&i.push(f)}}return i};var randomseed=0;function initrandomseed(t){randomseed=t}function myrandom(){var t=1e4*Math.sin(randomseed++);return t-Math.floor(t)}function rand(t,e){return myrandom()*(e-t)+t}function randitem(t){return t[Math.floor(rand(0,t.length))]}function lcircular(t,e){return t[e%t.length]}function lconcat(t,e){return t.concat(e)}function lrepeat(t,e){for(var i=[],r=0,r=0;r<e;r++)i.push(t);return i}function lrepeatl(t,e){for(var i=[],r=0;r<e;r++)for(var n=0;n<t.length;n++)i.push(t[n]);return i}function sample(t,e,i){return t+(e-t)*i}function samplepower(t,e,i){return Math.exp(sample(Math.log(t),Math.log(e),i))}function samplespower(t,e,r){var n=[],a=samples(0,1,r);for(i=0;i<r;i++){var o=a[i];n.push(samplepower(t,e,o))}return n}function abscissa(t,e,i){return e<i?e:i<t||t==e?t:(i-t)/(e-t)}function samples(t,e,i){for(var r=[],n=0,n=0;n<i;n++)r.push(sample(t,e,n/i));return r}function lfill(t,e){for(var i=[],r=0;r<e;r++)i.push(t);return i}function llast(t){return t[t.length-1]}function lfirst(t){return t[0]}function lsum(t){for(var e=0,i=0;i<t.length;i++)e+=t[i];return e}function lreverse(t){for(var e=[],i=t.length-1;-1<i;i-=1)e.push(t[i]);return e}function randfluctuate(t,e){return rand(t*(1-e),t*(1+e))}function lrandfluctuate(t,e){for(var i=[],r=0;r<t.length;r++)i.push(randfluctuate(t[r],e));return i}function lgeo(t,e,i,r){for(var n=[1],a=0;a<r-1;a++)n.push(llast(n)*i);for(a=0;a<r;a++)n[a]=1-n[a];for(var o=lfirst(n),s=llast(n),a=0;a<r;a++){var l=abscissa(o,s,n[a]);n[a]=sample(t,e,l)}return n}function rcircular(t,e,i){var r=i,n=e-t;return i<t?r=e+(i-e-Math.floor((i-e)/n)*n):e<i&&(r=t+(i-t-Math.floor((i-t)/n)*n)),r}function rtrim(t,e,i){return e<=i?e:i<=t?t:i}function Point(t,e){this.x=t,this.y=e}function Circle(t,e,i){this.x=t,this.y=e,this.r=i,this.width=2*i,this.height=2*i,this.radius=i,this.descr=function(){return"x "+this.x+" y "+this.y+" r "+this.r}}function circle(t,e,i){return new Circle(t,e,i)}function ccenter(t){return new Point(t.x,t.y)}function cscale(t,e){return new Circle(t.x,t.y,t.r*e)}function rectangle(t,e,i,r){return{x:t,y:e,width:i,height:r}}function vrotate(t,e){var i=Math.sin(e),e=Math.cos(e);return $V([t.e(1)*e-t.e(2)*i,t.e(1)*i+t.e(2)*e])}function adjcircle(t,e,i){var r=$V([t.x,t.y]),i=vrotate($V([t.r+e,0]),i),i=r.add(i);return new Circle(i.e(1),i.e(2),e)}function circles2tangent2(t,e,i,r,n,a){var o=t.x,s=t.y,l=t.r,c=i.x,t=i.y,i=i.r,o=$V([o-c,s-t]),s=o.modulus();isens="IN"!=e&&"IN"!=r?1:-1;l+=isens*n,i+=n,s=(s*s-l*l+i*i)/(2*i*s);if(s<-1||1<s)return console.log("cosv ",s),[];a=Math.acos(s)*a,i=o.rotate(a,$V([0,0])).toUnitVector().multiply(i),i=$V([c,t]).add(i);return[new circle(i.e(1),i.e(2),n)]}function circles2tangent(t,e,i,r,n,a){var o=t.x,s=t.y,l=t.r,c=i.x,t=i.y,i=i.r,o=$V([o-c,s-t]),s=o.modulus();isens="IN"!=e&&"IN"!=r?1:-1;l+=isens*n,i+=n,s=(s*s-l*l+i*i)/(2*i*s);(s<-1||1<s)&&(s=s<-1?-1:1);a=Math.acos(s)*a,i=o.rotate(a,$V([0,0])).toUnitVector().multiply(i),i=$V([c,t]).add(i);return new Circle(i.e(1),i.e(2),n)}function circles2tangentbest(t,e,i,r){var n=Math.sqrt,a=t.x,o=t.y,s=t.r,l=e.x,c=e.y,t=e.r,e=a-l,a=o-c,o=n(e*e+a*a),s=s+i,t=t+i,s=(o*o-s*s+t*t)/(2*t*o);s<-1?s=-1:1<s&&(s=1);n=r*n(1-s*s);return[l+(s*e-n*a)*t/o,c+(n*e+s*a)*t/o,i]}function circles2tangentoptim(t,e,i,r){var n=t.x,a=t.y,o=t.r,s=e.x,l=e.y,t=e.r,e=n-s,n=a-l,a=Math.sqrt(e*e+n*n),o=o+ +i,t=t+i,o=(a*a-o*o+t*t)/(2*t*a);(o<-1||1<o)&&(o=o<-1?-1:1);r=Math.sqrt(1-o*o)*r;return[s+(o*e-r*n)*t/a,l+(r*e+o*n)*t/a,i]}function circles2tangentoptimarray(t,e,i,r,n,a){var o=t[0],s=t[1],l=t[2],c=e[0],d=e[1],t=e[2],e=o-c,o=s-d,s=a(e*e+o*o),l=l+i,t=t+i,l=(s*s-l*l+t*t)/(2*t*s);l<-1?l=-1:1<l&&(l=1);a=a(1-l*l)*r,r=a*e+l*o;n[0]=c+(l*e-a*o)*t/s,n[1]=d+r*t/s,n[2]=i}function circles2tangentoptimarray2(t,e,i,r,n,a,o,s,l,c){var d=t-r,t=e-n,e=c(d*d+t*t),i=i+o,a=a+o,i=(e*e-i*i+a*a)/(2*a*e);i<-1?i=-1:1<i&&(i=1);c=c(1-i*i)*s,s=c*d+i*t;l[0]=r+(i*d-c*t)*a/e,l[1]=n+s*a/e,l[2]=o}function circleviewbox(t){return[t.x-t.r,t.y-t.r,t.x+t.r,t.y+t.r]}function mergeviewboxes(t,e){if(e.length<=0)return t;var i=t[0],r=t[1],n=t[2],a=t[3],o=e[0],s=e[1],t=e[2],e=e[3];return[mymin([i,o]),mymin([r,s]),mymax([n,t]),mymax([a,e])]}function expandviewbox(t,e){var i=t[0],r=t[1],n=t[2],a=t[3],t=(n-i)*e,e=(a-r)*e,n=(i+n)/2,a=(r+a)/2;return[n-t/2,a-e/2,n+t/2,a+e/2]}function centerviewbox(t,e){var i=t[0],r=t[1],n=t[2],t=t[3],n=mymax([e[0]-i,n-e[0]]),t=mymax([e[1]-r,t-e[1]]);return[e[0]-n,e[1]-t,e[0]+n,e[1]+t]}function squareviewbox(t){var e=t[0],i=t[1],r=t[2],n=t[3],a=(r+e)/2,t=(n+i)/2,i=mymax([r-e,n-i])/2;return[a-i,t-i,a+i,t+i]}function ratioviewbox(t,e){var i=t[0],r=t[1],n=t[2],a=t[3],o=n-i,t=a-r,i=(n+i)/2,r=(a+r)/2;return 1<e?o*=e:t/=e,[i-o/2,r-t/2,i+o/2,r+o/2]}function convertviewboxwidthheight(t){var e=t[0],i=t[1];return[e,i,t[2]-e,t[3]-i]}function arecirclescolliding(t,e){var i=t.x-e.x,r=t.y-e.y,e=t.radius+e.radius;return i*i+r*r-e*e<-1e-6}function arecirclescollidingarray(t,e){var i=t[0]-e[0],r=t[1]-e[1],e=t[2]+e[2];return i*i+r*r-e*e<-1e-6}function arecirclescollidingoptim(t,e){var i=t.x-e.x,r=t.y-e.y,e=t.radius+e.radius;return i*i+r*r-e*e<-1e-6}function computecirclesviewbox(t){for(var e=circleviewbox(t[0]),i=1;i<t.length;++i)e=mergeviewboxes(e,circleviewbox(t[i]));return e}function checkcirclescollision(t,e,i){for(var r=0;r<t.length;++r)if(arecirclescolliding(e,t[r],i))return!0;return!1}function checkcollisionquadtreeadd(t,e){return t.iscollidingoptimadd(e)}function checkcollisionquadtreeaddoptim(t,e,i,r){return t.checkadd(e,i,r)}function collidings(t,e,i){return t.collidings(e,i)}function circlepoints(t,e,i){for(var r=[],n=$V([t.x,t.y]),a=$V([t.r,0]),o=samples(0,6.283138,e),s=0,s=0;s<o.length;s++){var l=n.add(vrotate(a,o[s]+i));r.push(new Point(l.e(1),l.e(2)))}return r}function linepoints(t,e,i){for(var r=[],n=samples(t.x,e.x,i),a=samples(t.y,e.y,i),o=0;o<i;o++)r.push(new Point(n[o],a[o]));return r}function linecircles(t,e,i){for(var r=[],n=linepoints(t,e,i),a=$V([t.x-e.x,t.y-e.y]).modulus()/i,o=0;o<n.length;o++){var s=n[o];r.push(new Circle(s.x,s.y,a))}return r}function dist2(t,e){var i=t.x-e.x,e=t.y-e.y;return i*i+e*e}function arecircletangent(t,e){var i=(t.x-e.x)*(t.x-e.x)+(t.y-e.y)*(t.y-e.y),e=(t.r+e.r)*(t.r+e.r);return(i-e)*(i-e)/e<1e-5}function Color(t,e,i,r){this.r=t,this.g=e,this.b=i,this.a=r}function myhsla(t,e,i,r){return(new Color).hsla(t,e,i,r)}Color.prototype.rgba=function(t,e,i,r){return new Color(t,e,i,r)},Color.prototype.v4=function(){return[this.r,this.g,this.b,this.a]},Color.white=function(){return Color.prototype.rgba(1,1,1,1)},Color.black=function(){return Color.prototype.rgba(0,0,0,1)},Color.red=function(){return Color.prototype.rgba(1,0,0,1)},Color.prototype.HEXtoRGB=function(t){return[(t>>16&255)/255,(t>>8&255)/255,(255&t)/255]},Color.prototype.hexa=function(){return 256*Math.round(255*this.r)*256+256*Math.round(255*this.g)+Math.round(255*this.b)},Color.prototype._getHSLcomponent=function(t,e,i){for(var r=t;r<0;)r+=1;for(;1<r;)r-=1;return r=r<1/6?e+6*(i-e)*r:1/6<=r&&r<.5?i:.5<=r&&r<2/3?e+6*(i-e)*(2/3-r):e},Color.prototype._hsl2rgb=function(t,e,i){var r=0,n=2*i-(r=i<.5?i*(1+e):i+e-i*e),i=360*t/360,e=i,t=i-1/3;return[this._getHSLcomponent(i+1/3,n,r),e=this._getHSLcomponent(e,n,r),t=this._getHSLcomponent(t,n,r)]},Color.prototype.hsla=function(t,e,i,r){t=rcircular(0,1,t),e=rtrim(0,1,e),i=rtrim(0,1,i),r=rtrim(0,1,r),i=this._hsl2rgb(t,e,i);return this.r=i[0],this.g=i[1],this.b=i[2],this.a=r,this};const SIZENODERESULT=8,SIZENODEFRONT=4,SIZEPLUGFRONT=2*SIZENODEFRONT+2;function rootseedratio(t,e){return[[0,t*e,t*e],[0,-e,e],1]}function bpatternpackingalternate(t,e,i,r){this.front=[],this.frontfrontindex=0,this.frontbackindex=0,this.nnodes=0,this.npatterns=0,this.plugs=t,this.plugresult=!1;for(var n=this.front,a=0;a<t.length;a++)n[this.frontbackindex++]=t[a][0][0],n[this.frontbackindex++]=t[a][0][1],n[this.frontbackindex++]=t[a][0][2],n[this.frontbackindex++]=this.nnodes++,n[this.frontbackindex++]=t[a][1][0],n[this.frontbackindex++]=t[a][1][1],n[this.frontbackindex++]=t[a][1][2],n[this.frontbackindex++]=this.nnodes++,n[this.frontbackindex++]=t[a][2],n[this.frontbackindex++]=this.npatterns,t[a][3]=this.npatterns,this.npatterns++;this.maxsize=i,this.minsize=r,this.initratios=function(t){this.mratios=t,this.mmap=new Map;for(var e=this.mratioindex=0,e=0;e<t.length-1;e++){var i=t[e],r=t[e+1],n=i/r,a=r/i;this.mmap.set(Math.round(1e6*i),r),this.mmap.set(Math.round(1e6*n),r),this.mmap.set(Math.round(1e6*a),r)}},this.initratios(e),this.radiusf=function(t,e){var i=Math.round(1e6*(t<e?t/e:e/t)),r=null;const n=this.mmap;return n.has(i)?r=n.get(i):(r=(t=this.mratios)[this.mratioindex%t.length],n.set(i,r),this.mratioindex+=1),r*e},this.reinitfront=function(t){var e=this.front;this.front.length!==t&&(e=new Float64Array(t));for(var i=this.front,r=this.frontfrontindex,n=0;r<this.frontbackindex;)e[n++]=i[r++];this.front=e,this.frontbackindex=this.frontbackindex-this.frontfrontindex,this.frontfrontindex=0},this.iter=function(t,e){console.log("niter",e);var i=(e=Math.floor(e))*SIZEPLUGFRONT;this.reinitfront(i);const r=new Float64Array((e+2*this.plugs.length)*SIZENODERESULT);var n=this.minsize,a=this.maxsize;const o=this.front,s=Math.sqrt;var l=this.frontfrontindex,c=this.frontbackindex,d=this.nnodes,p=this.npatterns,u=0;if(!1===this.plugresult){for(var h=this.plugs,f=0;f<h.length;f++)r[u++]=h[f][0][0],r[u++]=h[f][0][1],r[u++]=h[f][0][2],r[u++]=0,r[u++]=-1,r[u++]=-1,r[u++]=h[f][3],r[u++]=0,r[u++]=h[f][1][0],r[u++]=h[f][1][1],r[u++]=h[f][1][2],r[u++]=0,r[u++]=-1,r[u++]=-1,r[u++]=h[f][3],r[u++]=0;this.plugresult=!0}for(var m,x,g,v,b,y,w,E,C,A,k,R,S,M,T,L,I,N,O=0;O<e;O++)l!==c&&(m=o[l++],x=o[l++],g=o[l++],v=o[l++],b=o[l++],y=o[l++],w=o[l++],E=o[l++],C=o[l++],A=o[l++],n<(k=this.radiusf(g,w))&&k<a&&(R=m-b,S=x-y,(M=((N=s(R*R+S*S))*N-(L=g+k)*L+(I=w+k)*I)/(2*I*N))<-1?M=-1:1<M&&(M=1),T=C*s(1-M*M),t.checkadd(L=b+(M*R-T*S)*I/N,I=y+(T*R+M*S)*I/N,k)&&(N=(E<v?v:E)+1,o[--l]=A,o[--l]=-C,o[--l]=v,o[--l]=g,o[--l]=x,o[--l]=m,o[--l]=N,o[--l]=k,o[--l]=I,o[--l]=L,c<i&&(o[c++]=L,o[c++]=I,o[c++]=k,o[c++]=N,o[c++]=b,o[c++]=y,o[c++]=w,o[c++]=E,o[c++]=C,o[c++]=p++),r[u++]=L,r[u++]=I,r[u++]=k,r[u++]=N,r[u++]=v,r[u++]=E,r[u++]=A,r[u++]=Math.floor(1e6*(k/w*10+k/g)))));return this.front=o,this.frontfrontindex=l,this.frontbackindex=c,this.nnodes=d,this.npatterns=p,[r,u]}}function altvarclosedlessminiseed(t,e,i){t=t.map(function(t){return sample(.5,1.2,t)});return new bpatternpackingalternate([rootseedratio(t[0],.1)],t,.5*e,i)}function altvarclosedlessminiseedoptim(t,e,i){var r=t.map(function(t){return sample(.5,1.2,t)}),t=rootseedratio(r[0],.1);return new bpatternpackingalternateoptim([t],r,.5*e,i)}function altvarclosedless(t,e,i){t=t.map(function(t){return sample(.5,1.2,t)});return new bpatternpackingalternate([rootseedratio(t[0],1)],t,100*e,i)}function altvarclosed(t,e,i){t=t.map(function(t){return sample(.5,1.2,t)});return new bpatternpackingalternate([rootseedratio(t[0],1)],t,100*e,i)}function miniseed10(t,e,i){t=t.map(function(t){return sample(.5,1.2,t)});return new bpatternpackingalternate([rootseedratio((t=t.slice(0,10))[0],.1)],t,.5*e,i)}function miniseed5(t,e,i){t=t.map(function(t){return sample(.5,1.2,t)});return new bpatternpackingalternate([rootseedratio((t=t.slice(0,5))[0],.1)],t,.5*e,i)}var patterndict={map:[],declarepattern:function(t,e){var i={};i.patternstring=t,i.f=e,this.map.push(i)},getbuilder:function(t){console.log("patterndict.getbuilder "+t);for(var e=0;e<this.map.length;e++){var i=this.map[e];if(i.patternstring==t)return i.f}return null}};patterndict.declarepattern("altvarclosedlessminiseed",altvarclosedlessminiseed),patterndict.declarepattern("altvarclosedlessminiseedblue",altvarclosedlessminiseed),patterndict.declarepattern("altvarclosedlessminiseedoptim",altvarclosedlessminiseedoptim),patterndict.declarepattern("altvarclosedless",altvarclosedless),patterndict.declarepattern("altvarclosed",altvarclosed),patterndict.declarepattern("10miniseed",miniseed10),patterndict.declarepattern("10miniseedblue",miniseed10),patterndict.declarepattern("10miniseedblack",miniseed10),patterndict.declarepattern("5miniseed",miniseed5);var webappparameters={apptype:"design",initwebsocket:!1,ismenudisplay:!1,fullscreen:!1},designparameters={maxsizefactor:10,maxiter:5e5,iratios:[.16809376251889785,.6642810270286498,.19552576378468606,.23001700705839012,.7558297789677474,.14954235075986227,.23933958428134577,.7382767368920653,.7216788330396394,.7630145449123378,.6809207564117329,.48515437569453196,.7006312496087269,.565213848845097,.7154030632307192,.7274236821549268,.42740418858724516,.9786203243141274,.24146952479747727,.7334347635793425,.5981047924266374,.8423545140123385,.5799741240935818,.7553065351908603,.8910825681774387,.6132842595477292,.11444612295438089,.1967623193123522,.45230572524997936,.9312678815478822],description:"",isisbackgroundblack:!0,x:0,name:"sequence",y:0,source:"/D2ADIR/2021/20210906/JSVG.explorefruits.framerate/main.html",viewscale:500,patternklass:"10miniseed",minsizefactor:.01},animparameters={},display={},MAXNCOLORS=16;const FLOATSIZE=4,NVERTEXPERCIRCLE=3,NFLOATPERLOC=4,NFLOATPERCIRCLEDEF=4,VERTEXSTRIDE=NFLOATPERLOC,CIRCLEFLOATSIZE=NVERTEXPERCIRCLE*VERTEXSTRIDE*FLOATSIZE;display.topicture=function(){var t=document.getElementById("canvasexplore"),e=t.toDataURL("image/png"),i=document.createElement("img");i.setAttribute("id","canvaspic"),i.setAttribute("class","canvaspic"),i.setAttribute("src",e),i.onclick=function(){display.tocanvas()},t.style.visibility="hidden",document.getElementsByClassName("main")[0].style.visibility="hidden",t.parentNode.appendChild(i)},display.tocanvas=function(){document.getElementById("canvasexplore").style.visibility="visible",document.getElementsByClassName("main")[0].style.visibility="visible";var t=document.getElementById("canvaspic");t.parentNode.removeChild(t)},display.rendernormal=function(){this.torenderanim=!1,this.restartdraw=!0},display.renderanim=function(){this.torenderanim=!0,this.restartdraw=!0},display.initanim=function(t,e){console.log("display.initanim cresultindex "+e+" ncircles "+e/8),this.animindex=0,display.animindexstartrandom=0,display.speed=2,colormanager.refreshdraw(),console.log("display.initanim cresultindex/8",e/8);var i=new Float32Array(e/8*CIRCLEFLOATSIZE);this.coords=i;for(var r=this.gl,n=0,a=0;n<e;){var o=t[n++],s=t[n++],l=t[n++]-.015,c=t[n++];n+=4,0<l&&(i[a++]=o,i[a++]=s,i[a++]=l,i[a++]=3*c+0,i[a++]=o,i[a++]=s,i[a++]=l,i[a++]=3*c+1,i[a++]=o,i[a++]=s,i[a++]=l,i[a++]=3*c+2)}this.ncirclesanim=a/12,r.bufferData(r.ARRAY_BUFFER,this.coords,r.DYNAMIC_DRAW),r.vertexAttribPointer(r.circledef,NFLOATPERCIRCLEDEF,r.FLOAT,!1,FLOATSIZE*VERTEXSTRIDE,0)},display.initframe=function(t,e){this.subcoordindex=0,this.ncircles=0,this.lastcoordindex=0,this.lastncircles=0,this.nstepcircles=e,this.buffernsteps=0};var patternset={clear:function(){patternset.npatterns=0,patternset.patternmap={},patternset.ratios=[],patternset.ratiomap={}},addpatterns:function(t,e,i){this.npatterns;this.npatterns=t.npatterns;for(var r,n,a=this.patternmap,o=this.ratiomap,s=this.ratios,t=s.length,l=0;l<i;)e[l+3],r=e[l+6],n=e[l+7],r in a||(a[r]=0),a[r]++,1===a[r]&&(-1===s.indexOf(n)&&s.push(n),o[r]=n),l+=SIZENODERESULT;return this.patternmap=a,this.ratiomap=o,[t,(this.ratios=s).length]},addresult:function(t,e,i){return this.addpatterns(t,e,i)}},colormanager={};colormanager.fixcolors=new Float32Array(4*MAXNCOLORS),colormanager.palettes=[],colormanager.palettes[0]=[[255,255,255]],colormanager.palettes[1]=[[0,0,0]],colormanager.palettes[2]=[[247,219,172],[215,50,57],[209,208,144],[160,89,67],[94,96,157],[236,149,56]],colormanager.palettes[3]=[[53,98,68],[18,247,41],[255,217,51],[18,173,42],[170,209,183],[255,62,51]];var i=0;for(colormanager.palettes[4]=new Array(MAXNCOLORS),i=0;i<MAXNCOLORS;i++){var newcolor=myhsla(i/MAXNCOLORS,1,.5,1);colormanager.palettes[4][i]=[255*newcolor.r,255*newcolor.g,255*newcolor.b]}colormanager.refreshdraw=function(){console.log("colormanager.refreshdraw"),colormanager.palette={},this.paletteindex=0;var t=this.fixcolors;console.log("paletteindex",display.colorpaletteindex%colormanager.palettes.length);var e=this.palettes[display.colorpaletteindex%colormanager.palettes.length];console.log("fix255",e,"length",e.length),this.nfixcolors=e.length;for(var i=0,r=0;r<e.length;r++){var n=e[r];t[i++]=n[0]/255,t[i++]=n[1]/255,t[i++]=n[2]/255,t[i++]=1}this.fixcolors=t,display.gl.uniform4fv(display.gl.colorsloc,colormanager.fixcolors)},colormanager.colordata=function(t,e,i){var r=i/SIZENODERESULT,n=new Uint8Array(r),a=this.palette;n.fill(1);for(var r=patternset.addresult(t,e,i),t=r[0],o=r[1],s=t;s<o;){var l=patternset.ratios[s++],c=(display.coloroffset+this.paletteindex++)%this.nfixcolors;a[l]=c}for(var s=3,d=0;s<i;){Math.round(e[s]);var p=Math.round(e[s+3]),p=patternset.ratiomap[p];n[d++]=a[p],s+=SIZENODERESULT}return this.palette=a,n},display.drawcircles=function(t,e,i){console.log("frame.drawcircles cresultindex",i);const r=this.subcoords;for(var n=colormanager.colordata(t,e,i),a=0,o=this.subcoordindex,s=0;a<i;){var l=1e3*n[s++],c=e[a++],d=e[a++],p=e[a++]-.01;e[a+3];a+=SIZENODERESULT-3,0<p&&(r[o++]=c,r[o++]=d,r[o++]=p,r[o++]=0+l,r[o++]=c,r[o++]=d,r[o++]=p,r[o++]=200+l,r[o++]=c,r[o++]=d,r[o++]=p,r[o++]=111+l)}this.subcoordindex=o,this.ncircles+=i/SIZENODERESULT,console.log("this.ncircles",this.ncircles)},display.computeViewPortMatrix=function(){var t=this.viewbox0,e=t[0],i=t[1],r=t[2],n=t[3],a=r-e,t=n-i,a=t<a?a:t,t=2/a,a=2/a*this.canvasratio,r=-((e+r)/2)*t,n=-((i+n)/2)*a;return console.log("computeViewPortMatrix scalex ",t," scaley ",a," tx ",r," ty ",n),new Float32Array([t,0,0,0,0,a,0,0,0,0,1,0,r,n,0,1])},display.computeScreenPortMatrix=function(){var t=this.viewbox0,e=t[0],i=t[1],r=t[2],n=t[3],a=(e+r)/2,o=(i+n)/2,s=r-e,t=n-i,r=(this.canvasratio,this.canvaswidth/s),e=this.canvasheight/t*this.canvasratio,n=this.canvaswidth/2-a*r,i=this.canvasheight/2-o*e;return console.log("canvas dims",this.canvaswidth,this.canvasheight,"scalex",r,"scaley",e,"xcenter",a,"ycenter",o),console.log("computeScreenPortMatrix scalex ",r," scaley ",e," tx ",n," ty ",i,"xwidth",s,"xheight",t),new Float32Array([r,0,0,0,0,e,0,0,0,0,1,0,n,i,0,1])},display.fragmentshaderscript=function(){return["#ifdef GL_OES_standard_derivatives","#extension GL_OES_standard_derivatives : enable","#endif","precision mediump float;","varying vec2  vCircleCenter;","varying vec4  vColor;","varying float vCircleRadius;","varying float vAlpha;","void main(void) {","vec2 cxy = vec2(gl_FragCoord) + vec2(0.5,0.5) - vCircleCenter;","float alpha = 1.0;","float r =  (dot(cxy, cxy))/(vCircleRadius * vCircleRadius);","#ifdef GL_OES_standard_derivatives"," float delta = fwidth(r);"," alpha = 1.0 - smoothstep(1.0 - delta, 1.0 + delta, r);","#endif","   gl_FragColor = vColor * alpha * vAlpha;","}"].join("\n")},display.vertexshaderscript=function(){return["attribute vec4  aCircleDef;","uniform   mat4  uModelViewMatrix;","uniform   mat4  uScreenViewMatrix;","uniform   vec4  uColors[16];","uniform   float uTime;","varying   vec2  vCircleCenter;","varying   float vCircleRadius;","varying   vec4  vColor;","varying   float vAlpha;","float random (vec2 st) {return fract(sin(dot(st.xy,vec2(12.9898,78.233)))*43758.5453123);}","void main(void) {","   float x = aCircleDef[0];","   float y = aCircleDef[1];","   float r = aCircleDef[2];","   int   pall = int(aCircleDef[3]);","   int   waveindex = pall/3;","   r = r + float(waveindex) * 0.00003;","   float r2 = r * 2.0;","   float r1 = r * 1.1 ;","   int   pindex = int(mod(float(pall),3.0));","   int   colorindex = 1-int(sign(pow(uTime,1.0+smoothstep(0.0,20000.0,uTime))-float(waveindex*waveindex)));","   int   mod2    = int(mod(float(pindex),2.0));","   float factorxr2 = float(pindex-1);","   float factoryr1 = float(mod2-1);","   float factoryr2 = float(mod2);","   float vertx = x + factorxr2 * r2 ;","   float verty = y + factoryr1 * r1 + factoryr2 * r2;","   mat4 zMatrix;","   float zoomScale = 0.66/(0.1 + 0.0 * 0.15 * smoothstep(0.0,8000.0,uTime)) ;","   zMatrix[0] = vec4(zoomScale, 0.0, 0.0,0.0);","   zMatrix[1] = vec4(0.0, zoomScale, 0.0,0.0);","   zMatrix[2] = vec4(0.0, 0.0, 0.0,0.0);","   zMatrix[3] = vec4(0.0, 0.0, 0.0,1.0);","   mat4 rMatrix;","   float rota = 0.0 * 2.0 * 3.14159 * uTime * 0.000002;","   rMatrix[0] = vec4(cos(rota), -sin(rota), 0.0,0.0);","   rMatrix[1] = vec4(sin(rota), cos(rota), 0.0,0.0);","   rMatrix[2] = vec4(0.0, 0.0, 0.0,0.0);","   rMatrix[3] = vec4(0.0, 0.0, 0.0,1.0);","   gl_Position     = uModelViewMatrix * zMatrix  * rMatrix  * vec4(vertx, verty, 0.0, 1.0);","   vCircleCenter   = vec2(uScreenViewMatrix * zMatrix * rMatrix * vec4(x, y, 0.0,1.0));","   vCircleRadius   = zMatrix[0][0] * uScreenViewMatrix[0][0] * r * (0.6 + (0.2 + 0.2 * sin((-0.15 * uTime + 3.5*float(waveindex))* 0.01)));","   vColor          = uColors[colorindex];","   vAlpha          = 1.0;","}"].join("\n")},display.initgl=function(t){t=getWebGLContext(t);if(t)return console.log("initgl done FLOAT size",t.FLOAT),t},display.initprogramgl=function(){var t=this.gl;vertexShader=loadShader(t,this.vertexshaderscript(),t.VERTEX_SHADER),fragmentShader=loadShader(t,this.fragmentshaderscript(),t.FRAGMENT_SHADER),program=createProgram(t,[vertexShader,fragmentShader]),t.useProgram(program),t.modelviewmatrixloc=t.getUniformLocation(program,"uModelViewMatrix"),t.screenviewmatrixloc=t.getUniformLocation(program,"uScreenViewMatrix"),t.colorsloc=t.getUniformLocation(program,"uColors"),t.time=t.getUniformLocation(program,"uTime"),t.circledef=t.getAttribLocation(program,"aCircleDef"),t.enableVertexAttribArray(t.circledef);var e=t.createBuffer();t.bindBuffer(t.ARRAY_BUFFER,e)},display.refreshviewbox=function(){this.viewbox0=mergeviewboxes(circleviewbox(new Circle(this.x,this.y,this.viewscaleend)),circleviewbox(new Circle(0,0,1))),this.viewbox0=expandviewbox(this.viewbox0,1),this.viewbox0=squareviewbox(expandviewbox(this.viewbox0,1)),console.log("display.refreshviewbox "+this.viewbox0[0]+" "+this.viewbox0[1]+" "+this.viewbox0[2]+" "+this.viewbox0[3])},display.clear=function(){var t=this.gl,e=this.background;t.clearColor(e.r,e.g,e.b,1),t.clear(t.COLOR_BUFFER_BIT)},display.initglflags=function(){var t=this.gl;t.enable(t.BLEND),t.blendFunc(t.SRC_ALPHA,t.ONE_MINUS_SRC_ALPHA),t.disable(t.DEPTH_TEST)},display.render=function(){var t;0<this.ncircles-this.lastncircles&&(t=this.gl,this.resetbufferdata(this.lastncircles,this.ncircles),t.bufferSubData(t.ARRAY_BUFFER,this.lastcoordindex*FLOATSIZE,this.subcoords),t.vertexAttribPointer(t.circledef,NFLOATPERCIRCLEDEF,t.FLOAT,!1,FLOATSIZE*VERTEXSTRIDE,FLOATSIZE*this.lastcoordindex),t.drawArrays(t.TRIANGLES,0*NVERTEXPERCIRCLE,(this.ncircles-this.lastncircles)*NVERTEXPERCIRCLE),this.lastncircles=this.ncircles,this.lastcoordindex=this.lastcoordindex+this.subcoordindex,this.subcoordindex=0,this.subcoords.fill(0))},display.init=function(t){this.viewscale=30,this.viewscaleend=this.viewscale,this.xincr=this.viewscale/10,this.yincr=this.viewscale/10,this.x=0,this.y=0,this.restartdraw=!0,this.canvas=null,this.gl=null,this.viewbox0=null,this.isfullscreen=!1,this.ismenudisplay=!0,this.background=Color.prototype.rgba(0,.125,.25,1),this.foreground=Color.white(),this.isisbackgroundblack=!1,this.coloroffset=0,this.colorpaletteindex=0,this.torenderanim=!0,this.canvas=document.getElementById("canvas"),this.gl=this.initgl(display.canvas),this.initprogramgl(),this.initglflags(),this.clear(),this.strperf="",this.sumperf=0,this.nperf=0,this.then=0,this.scaleupdate(1),this.xupdate(0),this.yupdate(0),this.coloroffsetincr(0),this.colorpaletteincr(0),this.colorrandu(!1),console.log("end display.init")},display.load=function(t){"viewscale"in t&&this.updateviewscale(t.viewscale),"x"in t&&(this.x=t.x),"y"in t&&(this.y=t.y),"isisbackgroundblack"in t&&(this.isisbackgroundblack=t.isisbackgroundblack),display.refreshviewbox()},display.scaleupdate=function(t){this.updateviewscale(this.viewscale*t),this.restartdraw=!0},display.updateviewscale=function(t){this.viewscale=t,this.xincr=t/10,this.yincr=t/10},display.xupdate=function(t){this.x=this.x+t*this.xincr,this.restartdraw=!0},display.yupdate=function(t){this.y=this.y+t*this.yincr,this.restartdraw=!0},display.updatefullscreen=function(t){(this.isfullscreen=t)?confirm("Fullscreen!")?document.documentElement.requestFullscreen():txt="You pressed Cancel!":document.exitFullscreen()},display.togglefullscreen=function(){this.updatefullscreen(!this.isfullscreen),display.restartdraw=!0},display.updatemenudisplay=function(t){display.ismenudisplay=t,this.ismenudisplay},display.togglemenudisplay=function(){this.updatemenudisplay(!this.ismenudisplay),this.restartdraw=!0},display.coloroffsetincr=function(t){this.coloroffset+=t,display.restartdraw=!0},display.colorpaletteincr=function(t){this.colorpaletteindex+=t,display.restartdraw=!0},display.colorrandu=function(t){this.colorrand=t,display.restartdraw=!0},display.togglecolor=function(){for(var t=null,e=null,e=this.isisbackgroundblack?(this.background=Color.white(),this.foreground=Color.black(),this.isisbackgroundblack=!1,t="white","black"):(this.background=Color.black(),this.foreground=Color.white(),this.isisbackgroundblack=!0,t="black","white"),i=document.querySelectorAll(".maincontrolcell"),r=0;r<i.length;r++)i[r].style.backgroundColor=t,i[r].style.color=e,i[r].style.borderColor=e;this.initprogramgl(),this.restartdraw=!0},display.animframe=function(t){var e;display.restartdraw&&(display.initframe(computation.maxiter,computation.niterperframe),display.iterframe(),display.animindex=0,display.restartdraw=!1),display.resizeCanvasToDisplaySize(),display.animindex<1e5&&(display.clear(),display.animindex+=15,(e=display.gl).uniform1f(e.time,display.animindex),e.drawArrays(e.TRIANGLES,0,display.ncirclesanim*NVERTEXPERCIRCLE),t*=.001,this.then,this.then=t),requestAnimFrame(display.animframe)},display.resizeCanvasToDisplaySize=function(){const t=this.canvas;var e,i,r=t.clientWidth,n=t.clientHeight,a=t.width!==r||t.height!==n;return a&&(console.log("display.resizeCanvasToDisplaySize need to resize canvase from "+t.width+","+t.height+" to "+r+","+n),i=t.width/r,t.width=r,t.height=n,this.canvaswidth=r,this.canvasheight=n,this.canvasratio=r/n,(e=this.gl).viewport(0,0,r,n),this.viewscaleend=this.viewscaleend/i,this.refreshviewbox(),i=this.computeViewPortMatrix(),e.uniformMatrix4fv(e.modelviewmatrixloc,!1,i),i=this.computeScreenPortMatrix(),e.uniformMatrix4fv(e.screenviewmatrixloc,!1,i)),a};var quadrant=function(){var t=0,e=0;const i=new Float64Array(+SIZENODERESULT);for(var r=0,t=0;t<1;t++)for(e=0;e<1;e++)i[r++]=0,i[r++]=0,i[r++]=50,i[r++]=10*t+e,i[r++]=0,i[r++]=0,i[r++]=0,i[r++]=0;return[i,+SIZENODERESULT]};display.iterframe=function(t){console.log("display.iterframe display "+display+" restartdraw "+display.restartdraw+" now "+t+" ");var e,i,r=null,n=0;display.restartdraw&&(this.strperf="",this.sumperf=0,this.nperf=0,computation.niter=0,computation.pattern=null,display.restartdraw=!1,colormanager.refreshdraw(),patternset.clear(),display.initframe(computation.maxiter,computation.niterperframe),i=patterndict.getbuilder(designparameters.patternklass),computation.pattern=i(explorer.lastratios(),computation.maxsizefactor,computation.minsizefactor),computation.quadtree=new MetaQuadTree(40,1,computation.errormargin)),computation.niter<computation.maxiter&&(e=Date.now(),console.log("start compute iter "+computation.niterperframe),i=computation.pattern.iter(computation.quadtree,computation.niterperframe),this.perf=Date.now()-e,this.sumperf+=this.perf,this.nperf+=1,this.strperf=" 100000 perf "+this.sumperf/this.nperf/computation.niterperframe*1e5+"  <br>",t*=.001,this.then,this.then=t,r=i[0],n=i[1],computation.niter+=computation.niterperframe),0<n&&!1===display.torenderanim&&(display.drawcircles(computation.pattern,r,n),display.render()),!1===display.torenderanim?requestAnimFrame(display.iterframe):(display.initanim(r,n),requestAnimFrame(display.animframe))},display.startrandom=function(){display.animindexstartrandom=display.animindex},display.speedup=function(){console.log("display.speedup"),display.speed*=10};var explorer={};function computenewrandomprobas(t,e){for(var i=t.slice(),r=0;r<t.length;r++)i[r]=rand(t[r]-.5*e,t[r]+.5*e);return i}explorer.load=function(t){"iratios"in t&&(this.baseratios=t.iratios.slice(),this.randomratios=this.baseratios.slice(),this.ratiohistory=[this.baseratios.slice()])},explorer.lastratios=function(){return this.randomratios},explorer.randomsizeupdate=function(t){this.randomprobasize=this.randomprobasize*t},explorer.setrandomratioarray=function(t){for(var e=0;e<t.length;e++)this.randomratios[e]=t[e]},explorer.randomnext=function(){console.log("ratiohistoryindex"+this.ratiohistoryindex+"history size"+this.ratiohistory.length),this.ratiohistoryindex=this.ratiohistoryindex+1,this.ratiohistoryindex<this.ratiohistory.length?this.setrandomratioarray(this.ratiohistory[this.ratiohistoryindex]):(this.setrandomratioarray(computenewrandomprobas(this.baseratios,this.randomprobasize)),this.ratiohistory.push(this.randomratios.slice())),display.restartdraw=!0},explorer.randomprev=function(){console.log("ratiohistoryindex"+this.ratiohistoryindex+"history size"+this.ratiohistory.length),this.ratiohistoryindex=this.ratiohistoryindex-1,this.ratiohistoryindex<0&&(this.ratiohistoryindex=0),this.setrandomratioarray(this.ratiohistory[this.ratiohistoryindex]),display.restartdraw=!0},explorer.probaindexincr=function(t){this.probaindex=this.probaindex+t,this.probaindex>this.randomratios.length-1&&(this.probaindex=0),this.probaindex<0&&(this.probaindex=this.randomratios.length-1)},explorer.updateproba=function(t,e){console.log("explorer.updateproba index "+t+" incr "+e+" old value "+this.randomratios[t]);var i=this.randomratios.slice();i[t]=i[t]+this.probaincrsize*e,this.setrandomratioarray(i),this.ratiohistoryindex=this.ratiohistoryindex+1,this.ratiohistory.push(this.randomratios.slice()),display.restartdraw=!0},explorer.updateprobabyfactor=function(t){console.log("explorer.updateproba factor "+t);for(var e=this.randomratios.slice(),i=0;i<e.length;i++)e[i]=e[i]*t;this.setrandomratioarray(e),this.ratiohistoryindex=this.ratiohistoryindex+1,this.ratiohistory.push(this.randomratios.slice()),display.restartdraw=!0},explorer.probaincr=function(t){this.updateproba(this.probaindex,t)},explorer.probascale=function(t){this.updateprobabyfactor(t)},explorer.probaincrsizeupdate=function(t){this.probaincrsize=this.probaincrsize*t},explorer.init=function(t){this.baseratios=null,this.randomratios=null,this.ratiohistory=[],this.ratiohistoryindex=0,this.randomprobasize=.001,this.probaincrsize=.001,this.probascalev=1,initrandomseed(this.probaindex=0),this.load(t),this.randomsizeupdate(1),this.probaindexincr(0),this.probaincrsizeupdate(1),this.probaincr(0),this.probascale(1)};var computation={load:function(t){"maxiter"in t&&(this.maxiter=t.maxiter),"maxsizefactor"in t&&(this.maxsizefactor=t.maxsizefactor),"minsizefactor"in t&&(this.minsizefactor=t.minsizefactor)},maxiterupdate:function(t){!(1<t)||this.maxiter<7e6?this.maxiter=this.maxiter*t:this.maxiter=this.maxiter+1e6,!1===display.torenderanim?this.niterperframe=this.maxiter/10:this.niterperframe=this.maxiter,display.restartdraw=!0},maxsizeupdate:function(t){this.maxsizefactor=this.maxsizefactor*t,display.restartdraw=!0},minsizeupdate:function(t){this.minsizefactor=this.minsizefactor*t,display.restartdraw=!0},init:function(t){computation.niter=0,computation.quadtree=null,computation.pattern=null,computation.errormargin=1e-5,computation.maxiter=1e6,computation.niterperframe=5e4,computation.maxsizefactor=1,computation.minsizefactor=.01,computation.load(t),this.maxiterupdate(1),this.maxsizeupdate(1)}},patternparams={load:function(t){this.iratios=t.iratios,this.patternklass=t.patternklass}},webapp={};function logKey(t){console.log("logKey "+t.code),display.togglemenudisplay()}webapp.computecurrentdesign=function(){var t,e=window.location.href;-1<e.indexOf("designview")&&(t=e.split("="),webapp.currentdesign=t[t.length-1]),-1<e.indexOf("D2ADIR")&&(t=e.split("/"),webapp.currentdesign=t[t.length-2])},webapp.addcontrol=function(t,e,i,r,n){var a="cmdleft"+t,o="cmdright"+t;this.table.innerHTML=this.table.innerHTML+('\t    <tr id="'+("tr"+t)+'" class="rowcontrol"><td id="'+a+'" class="leftcell maincontrolcell">'+e+'</td><td id="'+("cmdcenter"+t)+'" class="centercell"></td><td id="'+o+'" class="rightcell maincontrolcell">'+r+"</td></tr>"),linkleft={},linkleft.id=a,linkleft.cmd=i,linkright={},linkright.id=o,linkright.cmd=n,this.links.push(linkleft),this.links.push(linkright);for(var s=0;s<this.links.length;s++)addclick(this.links[s].id,this.links[s].cmd)},webapp.answer=function(){console.log("asnwer html"+this.responseText)},webapp.initwebsocket=function(){this.req=new XMLHttpRequest,this.req.onload=webapp.answer,this.websocket=new WebSocket(this.render_endpoint()),this.setupwebsocketdefaults(this.websocket,this.socketreceive)},webapp.uploaddesign=function(t){t.source=window.location.href.replace(this.locationroot(),"");t=JSON.stringify(t);console.log("sobj "+t);t=this.locationroot()+"/dots/uploaddesign?design="+t;console.log("uploaddesign url "+t),window.location=t},webapp.getiterdesign=function(t,e){console.log("");t=this.locationroot()+"/dots2artjs/iterdesign"+e+"?design="+t;this.req.open("get",t,!0),this.req.send()},webapp.uploadcurrentdesign=function(){var t={};t.patternklass=patternparams.patternklass,t.iratios=explorer.lastratios(),t.maxiter=computation.maxiter,t.maxsizefactor=computation.maxsizefactor,t.minsizefactor=computation.minsizefactor,t.viewscale=display.viewscale,t.x=display.x,t.y=display.y,t.isisbackgroundblack=display.isisbackgroundblack,this.uploaddesign(t)},webapp.locationroot=function(){var t="http://dots2art.duckdns.org:8888";return window.location.href.startsWith("http://localhost")&&(t="http://localhost:8888"),console.log("webapp.locationroot current url "+window.location.href+" result "+t),t},webapp.load=function(){window.location=this.locationroot()+"/dots2artjs/designs"},webapp.savenext=function(){this.getiterdesign(this.currentdesign,"next"),this.req.onload=webapp.dosavenext},webapp.saveprev=function(){this.getiterdesign(this.currentdesign,"prev"),this.req.onload=webapp.dosaveprev},webapp.dosavenext=function(){webapp.updatecurrentdesign(this.responseText)},webapp.dosaveprev=function(){webapp.updatecurrentdesign(this.responseText)},webapp.updatecurrentdesign=function(t){console.log("updatecurrentdesign "+t),webapp.currentdesign=t,window.location=this.locationroot()+"/dots2artjs/designview?design="+t},webapp.setupwebsocketdefaults=function(t,e){return t.onmessage=function(t){e(SOCKCLIENT,t.data)},t.onopen=function(t){console.log("onopen done")},t.onclose=function(t){console.log("onclose.")},t.onerror=function(t){console.log("Error!")},t},webapp.render_endpoint=function(){return"ws://localhost:8888/sample"},webapp.socketreceive=function(t,e){console.log("input reeceive to message "+e)},webapp.torender=function(){this.render=!0,this.websocket.send("drawstart png "+this.currentdesign);var t="black";!1===display.isisbackgroundblack&&(t="white"),this.websocket.send("drawbackground "+t),display.restartdraw=!0},webapp.torendersvg=function(){this.render=!0,this.websocket.send("drawstart svg "+this.currentdesign),display.restartdraw=!0},webapp.updatecontrollabels=function(t,e,i){document.getElementById("cmdleft"+t).innerHTML=e,document.getElementById("cmdright"+t).innerHTML=i},webapp.init=function(t){this.table=document.getElementById("maincontrol"),document.onkeypress=logKey,this.links=[],this.currentdesign="unknown",this.render=!1,this.websocket=null,webapp.addcontrol("fullscreen","FULL",function(){display.togglefullscreen()},"FULL",function(){display.togglefullscreen()}),webapp.addcontrol("prevsave","SAVE--",function(){webapp.saveprev()},"SAVE++",function(){webapp.savenext()}),webapp.addcontrol("B&W","B&W",function(){display.togglecolor()},"B&W",function(){display.togglecolor()}),webapp.addcontrol("maxiter","ITER--",function(){computation.maxiterupdate(.5)},"ITER++",function(){computation.maxiterupdate(2)}),webapp.addcontrol("scale","ZIN",function(){display.scaleupdate(.5)},"ZOUT",function(){display.scaleupdate(2)}),webapp.addcontrol("x","LEFT",function(){display.xupdate(-1)},"RIGHT",function(){display.xupdate(1)}),webapp.addcontrol("y","DOWN",function(){display.yupdate(1)},"UP",function(){display.yupdate(-1)}),webapp.addcontrol("randomsize","RANDS--",function(){explorer.randomsizeupdate(.5)},"RANDS++",function(){explorer.randomsizeupdate(2)}),webapp.addcontrol("randomexplore","PRAND",function(){explorer.randomprev()},"NRAND",function(){explorer.randomnext()}),webapp.addcontrol("loadsave","LOAD",function(){webapp.load()},"SAVE",function(){webapp.uploadcurrentdesign()}),webapp.addcontrol("probaindex","PBI--",function(){explorer.probaindexincr(-1)},"PBI++",function(){explorer.probaindexincr(1)}),webapp.addcontrol("probaincrsize","PBS--",function(){explorer.probaincrsizeupdate(.1)},"PBS++",function(){explorer.probaincrsizeupdate(10)}),webapp.addcontrol("proba","PB--",function(){explorer.probaincr(-1)},"PB++",function(){explorer.probaincr(1)}),webapp.addcontrol("probascale","PB*--",function(){explorer.probascale(.9)},"PB*++",function(){explorer.probascale(1.1)}),webapp.addcontrol("savesvg","2CANVAS",function(){display.tocanvas()},"2SVG",function(){webapp.torendersvg()}),webapp.addcontrol("savepicture","2CANVAS",function(){display.tocanvas()},"2PIC",function(){webapp.torender()}),webapp.addcontrol("rendernormal","2NORMAL",function(){display.rendernormal()},"2ANIM",function(){display.renderanim()}),webapp.addcontrol("maxsize","MAXS--",function(){computation.maxsizeupdate(.75)},"MAXS++",function(){computation.maxsizeupdate(1.5)}),webapp.addcontrol("minsize","MINS--",function(){computation.minsizeupdate(.75)},"MINS++",function(){computation.minsizeupdate(1.5)}),webapp.addcontrol("coloroffset","COLORO--",function(){display.coloroffsetincr(-1)},"COLORO++",function(){display.coloroffsetincr(1)}),webapp.addcontrol("colorpalette","COLORR--",function(){display.colorpaletteincr(-1)},"COLORR++",function(){display.colorpaletteincr(1)}),webapp.addcontrol("colorrand","COLRAND--",function(){display.colorrandu(!1)},"COLRAND++",function(){display.colorrandu(!0)}),webapp.computecurrentdesign(),t.initwebsocket&&webapp.initwebsocket(),display.updatemenudisplay(t.ismenudisplay)},display.init(designparameters),computation.init(designparameters),explorer.init(designparameters),display.load(designparameters),display.iterframe();