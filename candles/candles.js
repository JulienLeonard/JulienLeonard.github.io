
var canvasname    = "candles";
var colgrid      = null;
var quadtree     = null;
var lastpatternid = 0;
var patterns      = [];
var canvas        = null;
var gl            = null;
// var ratios        = [0.12819115916648469,0.5088121111080107,0.6051513923356083,0.7794509845690107,0.23269765136423412,0.9494264786827501,0.01082722098139451,0.973103034297518,0.9426974383847311,0.9158469321745666,0.6393890579414503,0.21189682195517087,0.3498866005567306,0.5440955569707302,0.6140260070627677,0.9351007039356515,0.2375310464936919,0.18429841947941966,0.5035361906064377,0.9327555223986299,0.8220649537733127,0.4456780680667973,0.5112899986613961,0.2510075020841358,0.68308752807001,0.6520842726584917,0.580370571268895,0.288191316317856,0.6314533542056816,0.8365241348913518];
// var ratios        = [0.8249820553813978,0.473404795151858,0.5143921172779017,0.3883150896934397,0.4117124776410463,0.6516117130646537,0.6380614776341531,0.8992545972109095,0.7720153237562698,0.26154637162645644,0.809867925853407,0.4502298182110441,0.012554673018192254,0.006389416757221062,0.38692743861439055,0.08946079206162169,0.5675321796757784,0.5133438108085393,0.7694282591200565,0.7807510307900379,0.08257448816791851,0.8294226382064739,0.1062803362059781,0.25361061387397843,0.4335873799554945,0.3030949119958537,0.11618591431350722,0.7366618671159548,0.07600061785243481,0.34238424587174515];
// var ratios = [0.2513623462297778,0.6469530838760329,0.3404807044847313,0.45920027487874043,0.7790198869905527,0.9872406502194891,0.5536082389548459,0.49367211409549794,0.14722160303370171,0.3534821874245453,0.9751240443322454,0.9098130920481929,0.22863805397815912,0.7197732109202879,0.22835593727806394,0.9782378324206163,0.24324949329870263,0.29423387129522577,0.18867485885912313,0.05835284528245816,0.7362706622743377,0.5010208447934226,0.6573384430526469,0.8872123858366219,0.3785687561047118,0.6050838518911432,0.6442987344434014,0.728829790246128,0.4422846666734129,0.47839278004988695];
// var ratios = [0.15390028113215243,0.6020249880859745,0.23397476097288297,0.4138076712441666,0.8655306007086907,0.9728061109654634,0.9523069965431034,0.423690899938201,0.9729552613445349,0.45907741759860765,0.7141575797992561,0.8464436860971356,0.17903223455838496,0.9947662227762706,0.03590620077955825,0.4755165020355566,0.005849711599689774,0.3161028559860321,0.7407005572415425,0.954265558605206,0.3412434776971319,0.27912965569604636,0.33212328345148046,0.996024969032046,0.1916545215955258,0.13754445600209034,0.7096720271323211,0.45776001292176544,0.5725371761119632,0.6323189137654002];
// var ratios = [0.06178786561907635,0.46865745981627027,0.7259271320541981,0.6573084349079562,0.38286549802071673,0.8204252341857298,0.886910959559917,0.3124973235244385,0.14251647523721517,0.2743993118751791,0.829234686134958,0.9473698702395753,0.44540911654262294,0.9910217318642054,0.10224744170077492,0.4727526649240184,0.5540393779771586,0.7398256621043318,0.24990298750340145,0.11951096966839907,0.6208672167830482,0.9153124726914393,0.6567285250205214,0.6363200199028105,0.6305745065354623,0.06573134151554264,0.7466568517250274,0.061706942534869046,0.10858318354402817,0.9575658244814564];
// var ratios = [0.1827366683551747,0.255185045420744,0.895058386444607,0.24630097450981894,0.5804785865268105,0.10360375610348012,0.26832883119039647,0.8026658169937626,0.4043862141689221,0.5191015370744754,0.5395336107069317,0.9413951514015882,0.028309606494526195,0.7995563535017689,0.14363330423069806,0.044944205342300335,0.3772591880416773,0.5951734164707239,0.0796106234563564,0.01574843098211495,0.6838795164059287,0.963032234442901,0.6827642818366942,0.21928482932005303,0.5201263821311883,0.7641044788826743,0.3039765811078141,0.9343986790321761,0.43859849378401344,0.5248850279137888];
// var ratios = [0.6696767996389776,0.2579715322973074,0.7275433208455999,0.8205934519975415,0.7141477226811218,0.6807751016136143,0.7871328200153693,0.3413059983129175,0.32991364520504773,0.8586349612374953,0.07779351858319412,0.4756668277437179,0.5323738886659843,0.6079468091986826,0.7620222022580087,0.30715335035098407,0.32635934898925917,0.12157846247850845,0.36921887629163397,0.46165383349249783,0.015979508411129707,0.5675978658569967,0.617331458543116,0.48982373415018604,0.4674998621770646,0.27018360992436463,0.9759319987967293,0.4891037766305282,0.36717382928690584,0.09054882502674536];
// var ratios = [0.8265487401869841,0.8046763226411661,0.19495463007826108,0.6024677253339755,0.6750596881262305,0.7281783375554617,0.493319294645134,0.2173851007676614,0.5913886020851269,0.4682352447268717,0.6297581245329967,0.34479902607612267,0.03723126139362867,0.745810242717066,0.8327493457276138,0.018253644005513586,0.7889948006668104,0.6356148070821608,0.7780626298757561,0.8986203218338175,0.1117490609696829,0.16646771746057445,0.8229273598747922,0.9401374156308069,0.8895445069715122,0.5745286702059809,0.10336015192016966,0.17407332229152012,0.6503277535784653,0.05855439326658584];
var ratios = [0.9071813197374257,0.9964408269135472,0.18097793598704875,0.6961701343283849,0.5314476571657917,0.040773985460761,0.2883736390100669,0.6957508421948883,0.48440476948600486,0.3909607512834299,0.8773468206065459,0.5680139342173999,0.6101923918398993,0.5035296531876221,0.8228811243655538,0.163057211862438,0.5025597719953208,0.5220879253568537,0.731761472640448,0.7150706680096084,0.19271723748776934,0.9986104569391396,0.6459497761195292,0.4778872409266826,0.8508582547543841,0.3746876569346933,0.37545010139022494,0.1898540655103764,0.8772790328959371,0.42870588201503546];
// var ratios = [0.2065321245261152,0.18541691041803776,0.30201339596044896,0.9391459072656677,0.2252634140780491,0.0022004097710365475,0.9822870218112538,0.29797558174374306,0.07560236708987614,0.648983679548364,0.46870216935346937,0.47736032375942933,0.9949614247283719,0.31666540974595836,0.1955416003221374,0.46767661416329287,0.24085424246306264,0.037253076693626624,0.11245998978263698,0.11504827677973001,0.6163878369221407,0.630375150419015,0.7151530923858066,0.5780237282523996,0.8448007380798462,0.566004907975907,0.8444883510677555,0.31571639576727356,0.24546366056681782,0.5077431465069498];
// var ratios = [0.6203117457313052,0.579510506046708,0.8330751270209789,0.4936598415922652,0.9409576412015397,0.6750756742782312,0.996857594231543,0.18558624954222994,0.14809605625835065,0.050417534099154886,0.3674956044962144,0.4986247678746585,0.38647366938482675,0.46296135078322204,0.9914226136130386,0.8398669943399107,0.6445738708807965,0.3530478935470096,0.6759468445908031,0.638617037627202,0.23655140038419115,0.7193862571005646,0.724823089188348,0.10165998856614343,0.5994278311726767,0.5835585191769332,0.8680318067167102,0.010575487748987734,0.7422225972368487,0.535191759716343];
// var ratios = [0.32567538848411076,0.6262542524497278,0.4552209225740381,0.8980457018586089,0.4541111376388516,0.24589029617881883,0.6782078774078786,0.6397955942152979,0.044551976511511944,0.7850692289811881,0.6585314868290589,0.938699135993933,0.7163786500302975,0.17597105921058498,0.5455921523019635,0.7673037391003704,0.07394305992589474,0.7610081745130048,0.2643890400716984,0.5865964850348404,0.927123980562726,0.1727413177363301,0.26332719450040126,0.7401579682436576,0.8349722711532248,0.3789612722485146,0.20210268078469795,0.7397559484186377,0.07822507204405268,0.7287858443934404];
// BUG QUADTREE var ratios = [0.9344125333868025,0.6714486319904442,0.03715786339582776,0.5122100936771418,0.7150444317213467,0.7517639406732116,0.8965508946667197,0.3308866635574432,0.21215440994694568,0.679167978316158,0.7762115596682818,0.7876833448129162,0.59397627068403,0.9591813864927652,0.9615627839051014,0.9857090930387886,0.8127267029195683,0.49769596918378767,0.7761540719196918,0.8214867542597869,0.7278788442387613,0.4597351208607364,0.7681763063968049,0.7391816110998306,0.42533775485369274,0.6516458260135939,0.21139781047189507,0.9630006011403168,0.15110336530539364,0.5942606877508856];
// var ratios = [0.5327871625930011,0.5538417005696528,0.4174614741548251,0.27499612014507696,0.8597912783081603,0.5120145252496072,0.4281258701477786,0.5114995737147982,0.7733354246119668,0.4484814533258236,0.627786047117685,0.20009390693162285,0.9782937997851027,0.18389298821980737,0.6894530103027137,0.6367441577076652,0.759058592728832,0.4977679934807904,0.9866664316443104,0.9027166459256395,0.9586680722230431,0.33428985268543004,0.4095540840223218,0.37549016316211326,0.8631722656372806,0.336268565774089,0.6657849651136366,0.8479086648895912,0.8009307993580265,0.24394481035133117];
// var ratios = [0.24064933240443903,0.5933297214067214,0.09262768276623808,0.7934642521634065,0.7536861103743716,0.20245706206302022,0.6958420931807915,0.018060089563047554,0.5359252861402581,0.296284159317745,0.6478656533397109,0.6780356805203649,0.7456825057723012,0.6858745150667962,0.49297472764410766,0.42624751451716175,0.9419764899378533,0.7988663855003502,0.5473411043860675,0.1619414166370134,0.7493894182841244,0.9879531012791922,0.5277731993830638,0.2841620311532924,0.9112575933855295,0.5063720305945594,0.5947182027598462,0.42883378473521855,0.4094200448176917,0.12269325094422942];
// ratios = ratios.slice(0,10).map(function(x) {return sample(0.5,1.2,x);});
// ratios = ratios.slice(0,5).map(function(x) {return sample(0.5,1.2,x);});
ratios = ratios.map(function(x) {return sample(0.5,1.2,x);});
var viewbox0      = null;
var errormargin   = 0.00001;

function rootseedratio(ratio,scale) {
    return plug(new Circle(0.0,-ratio * scale,ratio * scale), new Circle(0.0,scale,scale),-1.0);
}

function context() {

    initrandomseed(0);

    initcanvas(canvasname);
    
    var iter = 0;
    var maxiter = 1000000;

    var startdate = (new Date()).getTime(); 
    
    if (patterns.length == 0) {
	seed = rootseedratio(ratios[0],0.1);
	patterns.push(new bpatternpackingalternate([seed],ratios));
    }

    // quadtree = initquadtree();
    
    quadtree = new MetaQuadTree(-200.0,-200.0,200.0,200.0,2.0,errormargin);
    // colgrid = new Colgrid(-100.0,-100.0,100.0,100.0);
    // console.log("quadtree " + quadtree);

    var minx = 0.0;
    var maxx = 0.0;
    var miny = 0.0;
    var maxy = 0.0;
    
    viewbox0 = mergeviewboxes(circleviewbox(new Circle(0.0,0.0,30.0)),circleviewbox(new Circle(0.0,0.0,1.0)));

    console.log("init viewbox0",viewbox0);

    var niterperframe = 100;
    
    function iterframe() {

	// console.log("iterframe iter",iter);
	// var niterperframe = maxiter - iter;
	//if (niterperframe > 200) {
	//    niterperframe = 200;
	//}
	if (niterperframe < maxiter) {
	    niterperframe = Math.floor(niterperframe * 1.03);
	} else {
	    niterperframe = 0;
	}
	// var color = Color.white();	

	if (iter < maxiter && patterns.length > 0) {
	    if ((iter % 100000) == 0) {
		// var currentdate = new Date(); 
		// var datetime = "Last Sync: " + currentdate.getDate() + "/"
                //     + (currentdate.getMonth()+1)  + "/" 
                //     + currentdate.getFullYear() + " @ "  
                //     + currentdate.getHours() + ":"  
                //     + currentdate.getMinutes() + ":" 
                //     + currentdate.getSeconds();
		// console.log("iter ",iter," date ",currentdate);
	    }

	    // aresult = patterns[0].iter(colgrid,canvas,niterperframe);
	    var aresult      = patterns[0].iter(quadtree,niterperframe);
	    var cresult      = aresult[0];
	    var cresultindex = aresult[1];

	    // console.log("iter cresultindex",cresultindex);
	    
	    if (cresultindex > 0) {
		gl.coords       = new Array(cresultindex * 3 * 5);
		gl.coordindex   = 0;
		gl.nnewcircles  = 0;
		
		for (var iresult = 0; iresult < cresultindex; iresult++) {
		    var nnewnode = cresult[iresult];
		    var newr     = nnewnode.r - 0.01;
		    if (newr > 0.0) {
			// viewbox0 = mergeviewboxes(circleviewbox(nnewnode),viewbox0);
			drawcircle(gl,nnewnode.x,nnewnode.y,newr);
			// if (nnewnode.x - newr < minx) {
			//     minx = nnewnode.x - newr;
			// }
			// if (nnewnode.x + newr > maxx) {
			//     maxx = nnewnode.x + newr;
			// }
			// if (nnewnode.y - newr < miny) {
			//     miny = nnewnode.y - newr;
			// }
			// if (nnewnode.y + newr > maxy) {
			//     maxy = nnewnode.y + newr;
			// }
		    }
		}

		// create the new buffer, bind the data, and add to the list of buffers
		gl.batchs.push(createnewbatch(gl));

	    }

	    iter += niterperframe ;
	}

	viewbox0 = expandviewbox(viewbox0,1.0);
	gl.viewbox0 = squareviewbox(expandviewbox(viewbox0,1.0));
	resetviewbox(gl);
	
	if (iter >= maxiter) {
	    var stopdate = (new Date()).getTime(); 
	    var duration = stopdate - startdate;
	    console.log("iter duration ",duration);
	    console.log("xmin",minx,"ymin",miny,"xmax",maxx,"ymax",maxy);
	}

	return relaunchloop(iter < maxiter,iterframe);
    }

    return iterframe;
}

startanim(context());

